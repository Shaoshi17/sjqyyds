---
created: 2023-12-14T08:24
updated: 2024-03-06T19:07
---
PHP文件上传代码通常使用move_upload_file方法配合\$file上传，如果是直接用上传者的后缀名而不进行判断和处理将存在漏洞


### 文件名后缀绕过
#### **文件名黑名单绕过**

##### **使用特殊的后缀**

漏洞原理：没进行黑名单的漏网之鱼

![截图.png](    Web/media/image22.png){width="5.760416666666667in"
height="0.9744313210848644in"}

黑名单规则不严谨，在某些特定的环境中，某些特殊的后缀名仍然会被当做php文件解析。

`Php|php2|php3|php4|php5|php6|php7|pht|phtm|phtml`

比如，黑名单禁止上传.asp|.aspx|.php|.jsp后缀文件。

但是Apache的httpd.conf配置文件中，有这样一行内容：

`AddType application/x-httpd-php .php .php3 .phtml`

这里上传`.php`、`.php3`、`.phtml`后缀的文件都可以当做php文件来执行。
##### **.htaccess解析**

漏洞原因：.htaccess文件是Apache服务器下的一个配置文件。其主要负责相关目录下的网页配置，即：在一个特定的文档目录中放置一个包含一个或多个指令的文件来对网页进行配置。

不过需要注意的是，.htaccess文件的作用域为其所在目录与其所有的子目录，不过若是子目录也存在.htaccess文件，则会覆盖父目录的.htaccess效果。

前提条件：[Apache](https://so.csdn.net/so/search?q=Apache&spm=1001.2101.3001.7020)开启.htaccess文件功能，可以上传.htaccess

最推荐的.htaccess内容，如果有限制就百度其他的内容

AddType application/x-httpd-php .jpg

==这样一写就可以将我们上传的jpg当php解析==
##### .user.ini绕过
实际上，除了PHP_INI_SYSTEM以外的模式都是可以通过.user.ini来设置的。而且，和php.ini不同的是，.user.ini是一个能被动态加载的ini文件。也就是说修改了.user.ini后，不需要重启服务器中间件，只需要等待`user_ini.cache_ttl`所设置的时间（默认为300秒），即可被重新加载。

这里就很清楚了，`.user.ini`实际上就是一个可以由用户”自定义“的php.ini，我们能够自定义的设置是模式为“PHP_INI_PERDIR 、 PHP_INI_USER”的设置。

其中有两个配置，可以用来制造后门：

auto_append_file   ; 指定一个文件，自动包含在要执行的文件前。
auto_prepend_file  ; 指定一个文件，自动包含在要执行的文件后。

使用方法很简单，直接写在.user.ini中：

auto_prepend_file=test.txt

或者

auto_append_file=test.txt

1. 新建一个文件名为`.user.ini`的文件，并将内容写为：
    
    - auto_prepend_file=test.txt
        
2. 将`.user.ini`上传至服务器
![[Pasted image 20231218044816.png]]
1. 新建一个文件名为`test.txt`的文件，并将内容写为：
    
    - <?php phpinfo();?>
        
        或者webshell
        
2. 将`test.txt`上传至服务器
    
    ![[Pasted image 20231218044836.png]]
##### **大小写绕过**

漏洞原因：虽然设置了黑名单但是没有统一大小写，导致可以使用.pHp或者.PHp上传木马上去

##### **点绕过**

漏洞原因：windows系统下，文件后缀名最后一个点会被自动去除，而Linux系统下不会，所以只能在windows系统中生效，上传.php.

##### **空格绕过**

漏洞原因：文件上传系统不完善，没考虑到空格的存在，导致上传可以加入空格.php
，导致存入系统，如果是windows系统会将空格默认去位空，删除后面的空格，所以存储进去的文件就变成了.php后缀名导致木马上传，所以直接在后面加空格就可以上传木马

##### **::\$DATA绕过**

漏洞原因：和上面的一样windows系统会自动去掉文件名后面的::\$DATA从而绕过检查，存储的时候又自动删除::\$DATA变成.php木马，所以直接在后面加::$DATA就可以上传木马

##### **双后缀名绕过**

漏洞原因：文件上传系统将上传的文件进行匹配匹配到的名单内后缀名就直接去除存储，上传a.php\-\--\>a然后就变成a了,所以我们直接上传.phphpp,去除一个我们直接重组成.php

#### **文件名白名单绕过**

##### **前端JS绕过**

漏洞原因：只判断了类型是否为image/png等符合类型的文件

抓包修改类型为image/png等等

##### **%00截断绕过**

在C语言中 "\\0"是C语言中的结束符，如果用户能传入\\0将可以实现截断

漏洞原理：00截断限制使用场景为：后端先获取用户上传的文件名如：1.php%00.jpg
，判断最后面是.jpg就成功放行储存，然后在储存的时候%00发生截断直接结束后面的字符导致存储成功的是1.php。

PHP的底层代码是C语言自然也存在这个问题，我们可以用到其他的语言场景中去。

这种情况常出现在ASP程序中，PHP
版本\<5.3.4时也会有这个情况，JSP中也会出现。

##### **0x00绕过**

0x00是十六进制表示方法，表示ASCII码为0的字符，在一些函数处理时，会把这个字符当作结束符。

##### **0x0a绕过**

0xa是十六进制表示法，表示为ascii码则为\\n换行符。
##### apache解析漏洞


影响版本：apache 1.x - apache 2.x
Apache解析漏洞主要是因为Apache默认一个文件==可以有多个用.分割得后缀==
==apache解析有个原则，当碰到不认识的解析名字就会向后解析，如果都不认识就暴露源码。==
例题：https://www.nssctf.cn/problem/3094
![[Pasted image 20231214193617.png]]

==当最右边的后缀无法识别（mime.types文件中的为合法后缀）则继续向左看==，直到碰到合法后缀才进行解析（以最后一个合法后缀为准）

![](渗透/media/image26.png)
###### Apache HTTPD 多后缀解析漏洞
漏洞概述：Apache HTTPD 支持一个文件拥有多个后缀，并为不同后缀执行不同的指令，比如配置文件： AddHandler application/x-httpd-php .php。==在有多个后缀的情况下,只要一个文件含有.php后缀的文件即将被识别成PHP文件==,没必要是最后一个后缀。利用这个特性,将会造成一个可以绕过上传白名单的解析漏洞。
![[Pasted image 20231215002603.png]]
###### Apache SSI 远程命令执行漏洞

**在测试任意文件上传漏洞的时候，****目标服务端可能不允许上传php后缀的文件****。如果目标服务器开启了****SSI与CGI****支持，我们可以上传一个****shtml文件****，并利用**

**<!--#exec cmd="id" -->** **语法执行任意命令**
###### Apache HTTPD 换行解析漏洞
漏洞编号：CVE-2017-15715
Apache HTTPD是一款HTTP服务器，它可以通过mod_php来运行PHP网页。
==其2.4.0~2.4.29版本中存在一个解析漏洞。==
在解析PHP时，1.php\x0A将被按照PHP后缀进行解析，导致绕过一些服务器的安全策略
![[Pasted image 20231215035143.png]]
先在这里加个a然后进入hex修改为0a
![[Pasted image 20231215035245.png]]
访问的时候在后面加%0a
![[Pasted image 20231215035407.png]]

### 文件内容绕过
如果上传空文件不成功说明是白名单
如果上传空文件成功说明是黑名单
#### 文件内容白名单绕过
##### **突破getimagesize文件头绕过**

漏洞原因：检查文件内容的文件头的前几个字符，我们直接在文件内容前面加几个GIF89a就可以绕过

##### **二次渲染绕过**

漏洞原因：不相信上用户上传的任何文件，对上传上的文件进行重新生成，防止恶意代码。

绕过二次渲染方法：

将包含恶意代码的图片

phpinfo.gif

服务器上传图片功能代码

下载上传后的图片，并用

winhex.exe一句话木马

使用winhex对比功能，找到原图片与上传后图片的相同之处，并在该位置插入恶意代码；

实际操作：winhex------》工具------》比较------》搜索相同；展示区，蓝色部分是没有发生变化的,

在图片相同处，蓝色部分位置中间插入恶意代码，并上传，成功绕过；

然后使用文件包含来利用木马

##### **条件竞争绕过**

漏洞原理：先将上传的文件保存在服务器中，然后再进行对比白名单，如果不在白名单就删除，所以我们可以一边疯狂上传一边疯狂访问执行跳转木马

\<?php fputs(fopen(\"info.php\", \"w\"), \'\<?php
\@eval(\$\_POST\[\"x\"\]);?\>\'); ?\>

这个跳转木马就是访问内容为这个的木马就会生产名字为info.php的木马文件内容为后面的内容从而产生木马。

#### 文件内容黑名单
##### PHP 标签绕过

